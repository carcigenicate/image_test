from scapy.layers.inet import UDP
from scapy.utils import PcapNgReader
from scapy.all import *

PATH = "/home/brendon/Desktop/dronecaps/isolated/up.pcapng"

INITIAL_HEADER = b'\xff\xd8\xff\xe1J\xb9Exif\x00\x00II*\x00\x08\x00\x00\x00\r\x00\x00\x01\x04\x00\x01\x00\x00\x00\xc0\x0f\x00\x00\x01\x01\x04\x00\x01\x00\x00\x00\xdc\x08\x00\x00\x0f\x01\x02\x00\x08\x00\x00\x00\xaa\x00\x00\x00\x10\x01\x02\x00\t\x00\x00\x00\xb2\x00\x00\x00\x12\x01\x03\x00\x01\x00\x00\x00\x01\x00\x00\x00\x1a\x01\x05\x00\x01\x00\x00\x00\xbc\x00\x00\x00\x1b\x01\x05\x00\x01\x00\x00\x00\xc4\x00\x00\x00(\x01\x03\x00\x01\x00\x00\x00\x02\x00\x00\x001\x01\x02\x00\x0e\x00\x00\x00\xcc\x00\x00\x002\x01\x02\x00\x14\x00\x00\x00\xda\x00\x00\x00\x13\x02\x03\x00\x01\x00\x00\x00\x01\x00\x00\x00i\x87\x04\x00\x01\x00\x00\x00\xee\x00\x00\x00%\x88\x04\x00\x01\x00\x00\x00\\\x17\x00\x00*\x18\x00\x00samsung\x00SM-N950W\x00\x00H\x00\x00\x00\x01\x00\x00\x00H\x00\x00\x00\x01\x00\x00\x00N950WVLS8DTJ1\x002021:02:04 11:41:10\x00\x1f\x00\x9a\x82\x05\x00\x01\x00\x00\x00h\x02\x00\x00\x9d\x82\x05\x00\x01\x00\x00\x00p\x02\x00\x00"\x88\x03\x00\x01\x00\x00\x00\x02\x00\x00\x00\'\x88\x03\x00\x01\x00\x00\x00}\x00\x00\x00\x00\x90\x07\x00\x04\x00\x00\x000220\x03\x90\x02\x00\x14\x00\x00\x00x\x02\x00\x00\x04\x90\x02\x00\x14\x00\x00\x00\x8c\x02\x00\x00\x01\x91\x07\x00\x04\x00\x00\x00\x01\x02\x03\x00\x01\x92\n\x00\x01\x00\x00\x00\xa0\x02\x00\x00\x02\x92\x05\x00\x01\x00\x00\x00\xa8\x02\x00\x00\x03\x92\n\x00\x01\x00\x00\x00\xb0\x02\x00\x00\x04\x92\n\x00\x01\x00\x00\x00\xb8\x02\x00\x00\x05\x92\x05\x00\x01\x00\x00\x00\xc0\x02\x00\x00\x07\x92\x03\x00\x01\x00\x00\x00\x02\x00\x00\x00\x08\x92\x03\x00\x01\x00\x00\x00\x00\x00\x00\x00\t\x92\x03\x00\x01\x00\x00\x00\x00\x00\x00\x00\n\x92\x05\x00\x01\x00\x00\x00\xc8\x02\x00\x00|\x92\x07\x00b\x00\x00\x00\xdc\x16\x00\x00\x86\x92\x07\x00\xf3\x13\x00\x00\xd0\x02\x00\x00\x00\xa0\x07\x00\x04\x00\x00\x000100\x01\xa0\x03\x00\x01\x00\x00\x00\x01\x00\x00\x00\x02\xa0\x04\x00\x01\x00\x00\x00\xc0\x0f\x00\x00\x03\xa0\x04\x00\x01\x00\x00\x00\xdc\x08\x00\x00\x05\xa0\x04\x00\x01\x00\x00\x00>\x17\x00\x00\x17\xa2\x03\x00\x01\x00\x00\x00\x02\x00\x00\x00\x01\xa3\x07\x00\x01\x00\x00\x00\x01\x00\x00\x00\x02\xa4\x03\x00\x01\x00\x00\x00\x00\x00\x00\x00\x03\xa4\x03\x00\x01\x00\x00\x00\x00\x00\x00\x00\x05\xa4\x03\x00\x01\x00\x00\x00\x1a\x00\x00\x00\x06\xa4\x03\x00\x01\x00\x00\x00\x00\x00\x00\x00 \xa4\x02\x00\x18\x00\x00\x00\xc4\x16\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00<\x00\x00\x00\xaa\x00\x00\x00d\x00\x00\x002021:02:04 11:41:10\x002021:02:04 11:41:10\x00\x12\x17\x00\x00\xe8\x03\x00\x00\x99\x00\x00\x00d\x00\x00\x00\xe1\x00\x00\x00d\x00\x00\x00\x00\x00\x00\x00\n\x00\x00\x00\x99\x00\x00\x00d\x00\x00\x00\xae\x01\x00\x00d\x00\x00\x00ASCII\x00\x00\x00\n\x00\x00\x00JKJK1\x07\x1a\x8c\xdd\x04\x01\x00\xb9\x0b\x01\x00&\xe7\x01\x00\xa3\xbc\x01\x00\x01\x00\x00\x00\x00@\x02\x00\x00@\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x80\x00\x13\x01\xf1\x15\x82"\x02\x00\x00\x00\x01\x00\xf8\xbc\x01\x009\x96\x01\x004_\xff\xff\x90\n\x00\x00\x02\xda\xff\xff6Z\x01\x00\xc6\xcb\xff\xff\x00\x10\x00\x00L$\xff\xff\xb3\xcb\x01\x00A"\x02\x00 "\x02\x00\x91\x11\x01\x00\x91\x11\x01\x00\x91\x11\x01\x00\x91\x11\x01\x00\x91\x11\x01\x00!"\x02\x00!"\x02\x00\x00\x11\x01\x00\x00\x11\x01\x00\x00\x11\x01\x00\x01\x11\x01\x00\x01\x11\x01\x00\x00\x11\x01\x00\x10\x11\x01\x00Q3\x03\x00A"\x02\x00 "\x02\x00\x91\x11\x01\x00\x91\x11\x01\x00\x91\x11\x01\x00\x11\x11\x01\x00\x11\x11\x01\x00!"\x02\x00\x01\x11\x01\x00\x00\x11\x01\x00\x00\x11\x01\x00\x00\x11\x01\x00\x10\x11\x01\x00\x10\x11\x01\x00 "\x02\x00Q3\x03\x00af\x06\x00A"\x02\x00 "\x02\x00\x91\x11\x01\x00 "\x02\x00\x11\x11\x01\x00\x11\x11\x01\x00!"\x02\x00 "\x02\x00A"\x02\x00A"\x02\x00Q3\x03\x00af\x06\x00\x10\x11\x01\x00\x00\x11\x01\x00Q3\x03\x00qf\x06\x00af\x06\x00\x91\x11\x01\x00!"\x02\x00!"\x02\x00\x11\x11\x01\x00!"\x02\x00!"\x02\x00"w\x07\x001"\x02\x00A"\x02\x00Q3\x03\x00Q3\x03\x00af\x06\x00Q3\x03\x00@"\x02\x00af\x06\x00af\x06\x00Q3\x03\x001"\x02\x00!"\x02\x00"w\x07\x00"w\x07\x00!"\x02\x00"w\x07\x00!"\x02\x00 "\x02\x000"\x02\x00@"\x02\x00P"\x02\x00`3\x03\x000"\x02\x00af\x06\x00A"\x02\x00A"\x02\x001"\x02\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00!"\x02\x00!"\x02\x00\x11\x11\x01\x00\x10\x11\x01\x00\x10\x11\x01\x00 "\x02\x00@"\x02\x00\x10\x11\x01\x00 "\x02\x00\x10\x11\x01\x00 "\x02\x00!"\x02\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00!"\x02\x00!"\x02\x00\x01\x11\x01\x00\x11\x11\x01\x00\x11\x11\x01\x00\x11\x11\x01\x00\x10\x11\x01\x00\x10\x11\x01\x00\x10\x11\x01\x00\x10\x11\x01\x00\x10\x11\x01\x00!"\x02\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00\x11\x11\x01\x00\x11\x11\x01\x00\x01\x11\x01\x00\x11\x11\x01\x00\x11\x11\x01\x00\x10\x11\x01\x00\x10\x11\x01\x00\x10\x11\x01\x00!"\x02\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00!"\x02\x00\x11\x11\x01\x00\x11\x11\x01\x00\x11\x11\x01\x00\x11\x11\x01\x00\x10\x11\x01\x00\x10\x11\x01\x00 "\x02\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00\x11\x11\x01\x00\x11\x11\x01\x00\x11\x11\x01\x00\x11\x11\x01\x00\x11\x11\x01\x00\x10\x11\x01\x00\x10\x11\x01\x00 "\x02\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00\x11\x11\x01\x00\x11\x11\x01\x00\x11\x11\x01\x00\x11\x11\x01\x00\x11\x11\x01\x00\x10\x11\x01\x00\x10\x11\x01\x00 "\x02\x00!"\x02\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00\x92\x99\t\x00!"\x02\x00 "\x02\x00\x11\x11\x01\x00\x11\x11\x01\x00\x11\x11\x01\x00\x11\x11\x01\x00\x10\x11\x01\x00\x10\x11\x01\x00 "\x02\x000"\x02\x00!"\x02\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00!"\x02\x00\x11\x11\x01\x00\x11\x11\x01\x00\x11\x11\x01\x00\x11\x11\x01\x00\x11\x11\x01\x00\x10\x11\x01\x00 "\x02\x00 "\x02\x00 "\x02\x001"\x02\x00!"\x02\x00"w\x07\x00"w\x07\x00"w\x07\x00"w\x07\x00!"\x02\x00\x11\x11\x01\x00\x11\x11\x01\x00\x11\x11\x01\x00\x11\x11\x01\x00\x11\x11\x01\x00\x10\x11\x01\x00 "\x02\x00 "\x02\x00@"\x02\x000"\x02\x00A"\x02\x00"w\x07\x00"w\x07\x002w\x07\x00"w\x07\x00!"\x02\x00\x11\x11\x01\x00\x10\x11\x01\x00\x10\x11\x01\x00\x00\x11\x01\x00\x92\x99\t\x00\x10\x11\x01\x00 "\x02\x00 "\x02\x00@"\x02\x00 "\x02\x001"\x02\x001"\x02\x00"w\x07\x00"w\x07\x00"w\x07\x00\x11\x11\x01\x00\x11\x11\x01\x00\x11\x11\x01\x00\x91\x11\x01\x00\x92\x99\t\x00\x92\x99\t\x00\x90"\x01\x10\xf3\x1a\x81!\x00\x10\xcb\x1d=\x1d\x00\x10\xce\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xed\x1d\x00\x10I\x1f\x00\x00\x00\x00\x00\x00<!\x00\x10\xac\x19\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00*"'
SOI_HEADER = b'\xff\xc0\x00\x11\x08\x01\x7A\x02\x58\x03\x01\x22\x00\x02\x11\x01\x03\x11\x01'

FRAG_OFFSET = 0x20
LIMIT_OFFSET = FRAG_OFFSET + 4
RAW_OFFSET = 0x38

VIDEO_PORT = 1234


def main():
    with PcapNgReader(PATH) as packets:
        pieces = []

        for p in packets:
            if UDP in p and p[UDP].sport == VIDEO_PORT:
                pay = p[UDP].load
                frag = pay[FRAG_OFFSET]
                limit = pay[LIMIT_OFFSET]  # Exclusive bound

                if (pieces and frag == limit - 1) or (pieces and frag == 0):
                    break
                elif pieces or frag == 0:
                    piece = pay[RAW_OFFSET:]
                    pieces.append(piece)

        full = b"".join(pieces)

        print(full)

        full = INITIAL_HEADER + full + b"\xFF\xD9"

        with open("output.jpg", "wb") as f:
            f.write(full)

